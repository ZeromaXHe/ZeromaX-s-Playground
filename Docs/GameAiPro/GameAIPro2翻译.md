https://www.gameaipro.com/

# 40 程序内容生成：概述

Gillian Smith

## 40.1 简介

程序内容生成（PCG）是使用人工智能系统来编写游戏的各个方面的过程，这些方面通常由人类设计师负责创建，从纹理和自然效果到关卡和任务，甚至到游戏规则本身。因此，PCG 系统的创建者负责捕捉设计师专业知识的某些方面——这对人工智能来说是一项具有挑战性的任务！

PCG 在许多游戏中被用于多种不同的目的。两个流行的动机是可重放性和适应性。PCG 可以提供大量内容，因此
每次玩家开始游戏，他们都会有不同的体验。结合可以推断玩家技能的 AI 系统，PCG 可以用作一种动态难度调整的形式，改变玩家将看到的内容以适应他们的技能水平。

PCG 的第一个例子是在游戏《精英 (Elite)》[Braben 84]中，整个银河系都是由计算机生成的，这样玩家就可以在不违反内存要求的情况下探索广阔的宇宙。然而，与大多数包含 PCG 的现代游戏不同，Elite 的内容生成完全是确定的，允许设计者完全控制由此产生的体验。换句话说，《精英》实际上是一款将 PCG 用作数据压缩形式的游戏。这一传统在演示中得到了延续，例如 .kkrieger [.theprodukkt 04]，其目标是以最小的代码占用最大限度地提高交互式场景的复杂性。然而，这不再是 PCG 系统的主要目标。

无论创作是否具有确定性，与 PCG 一起创作游戏时的主要矛盾之一是对最终产品保持一定程度的控制。在游戏中使用 PCG 可能很有诱惑力，因为希望减轻创作负担或弥补缺失的专业知识——例如，一个想要制作一个拥有庞大世界的游戏的小型独立团队可能会选择使用 PCG 来避免费力地手工创作这个世界。但是，虽然创建一个可以生成高度多样化内容的系统相对简单，但挑战在于确保内容的质量和满足游戏需求的能力。

PCG 有几种主要方法，为这种控制提供了不同的手段，并支持不同程度的控制。PCG 在游戏中使用的原因也有很多，这可以帮助游戏设计师和/或开发人员在创建系统时选择使用什么技术。《文明》[MicroProse 91]、《盗贼（Rogue）》[Toy 80]、《我的世界》[Persson 11]和《无主之地》[Gearbox Software 09]都是使用 PCG 的流行游戏的例子，但它们的方法和目的完全不同。

为了扩大范围，本章侧重于创建玩家在游戏中以某种方式交互的内容——思考关卡和任务，而不是涉及程序建模的纹理和树[Ebert 03]。它还将避免讨论游戏规则的程序生成，也就是说，截至本书出版时，这项研究还处于起步阶段[Smith，a.10，Togelius 08]。重点是内容的程序性创建（例如，关卡设计师会创建什么），而不是讲故事和NPC行为，尽管这些系统之间有很多关系。然而，虽然我们不会深入研究创建游戏规则的系统，但对于许多 PCG 系统来说，仍然有必要找到方法来正式指定游戏规则的各个方面，以确保生成可玩的内容。

本章将概述 PCG，调查创建内容生成器的不同技术，研究 PCG 如何融入游戏设计，并给出一些建议
为游戏选择合适的方法。最后，有指向文献和资源的指针，读者可以在其中找到有关 PCG 的更多详细信息，并学习如何及时了解 PCG 研究。

## 40.2 内容生成的技术方法

虽然没有现成的工具或框架来创建自己的 PCG 系统，但有几种常见的知识表示方法。本节将概述这些方法，并讨论它们之间的一些权衡。

### 40.2.1 算法和方法

在选择设计内容生成器的方法时，主要考虑因素之一是所需的控制范围和类型。PCG 的方法包括纯自下而上、基于模拟的方法，这些方法只允许控制世界的初始状态和操作员将其更改为自上而下、约束驱动的方法，这种方法让系统满足公司的创作约束，但创建和调试的成本可能更高。

#### 40.2.1.1 基于模拟

基于模拟的 PCG 方法从一个初始世界和一组可以改变该世界的运算符开始，然后在预定的时间段内运行模拟。例如，基于模拟的地形创建方法可能从海洋中的单个陆地、气候/降雨模型和侵蚀模型开始，以创建包含河流、湖泊、悬崖和海滩的新的大雨。矮人要塞[Bay 12 Games 06，Adams 15]是一款采用这种方法生成的游戏，具有完整的模拟，可以创建陆地、洞穴和世界历史。基于模拟的方法不允许在不使用生成和测试参数的情况下对系统的最终输出进行任何控制（在建构主义系统一节中进一步描述）。虽然模拟可能是一个控制有限的缓慢过程，但它有两个潜在的好处，这可能使它成为一个不错的选择：（1）它为你提供了一个可以参考或重放的内容历史，（2）它可以在游戏过程中运行，以创建一个对玩家的选择和行为做出反应的世界。

#### 40.2.1.2 建构主义（Constructionist）

建构主义方法是根据专门为游戏构建的算法将预制的构建块拼凑在一起的方法。该算法隐含了设计知识——过程中的任何智能都只存在于该算法所做的选择中，而不是更明确地表示为优化函数或一组设计约束。例如，许多类似罗格的液位发生器[Rogue Basin 12]使用建构主义方法建造不同的房间，然后在它们之间建造走廊。构造主义方法通常是临时的，专门针对一个特定的游戏，除此之外几乎没有适用性，主要面向开发人员，而不是设计师和艺术家。

建构主义方法通常完全依赖于它们的知识表示（见下文）。许多（虽然不是全部）方法涉及取大块的、预先写好的内容，并将它们随机地放在一起，就像机器人独角兽攻击（Robot Unicorn Attack）[[成人游泳]游戏10]或卡纳巴尔特（Canabalt）[Saltsman 09]等无休止的跑步游戏一样。这种建构主义方法可能更准确地命名为内容选择，在接下来的过程中没有试图做出明智的选择，但设计师对构建块有非常严格的控制。

构造系统难以控制，也难以获得良好的变化；如果可供选择的构建块有限，那么所有内容都很容易开始感觉相同。大型分支控制流结构也很难调试，特别是如果错误存在于很少执行的代码中。你可以花大量时间调整你的算法，以在一个位置获得恰到好处的内容，而不会意识到你同时为一些不同的情况破坏了内容。

然而，从头开始设计自己的算法确实有一些好处。从设计的角度来看，内容选择是一种轻量级的方法，对于某些游戏来说已经足够好了，尤其是在对可玩性没有太多限制的情况下（例如，像卡纳巴尔特（Canabalt）这样的简单平台游戏只需要平台可以访问，而像乔里斯·多曼斯的《塞尔达传说》这样的锁和钥匙益智游戏[Dormans 10]则有更深的限制）。

#### 40.2.1.3 语法

基于语法的方法首先将内容的可能性空间（或生成空间）指定为形式语法。接下来，构建该语法的解释器（它将解析和处理规则以创建内容）。语法规则与内容组装的这种显式分离提供了比建构主义方法更多的组织，在建构主义方法中，规则通常在代码中隐式定义，对于技术设计师来说也很有用，他们可能能够编辑语法规则而无需接触内容组装系统。语法已被用于为平台游戏[Smith，G.11c]和动作冒险游戏[Domans 10]创建关卡，以及用于快速设计建筑物的工具[Müller 06]。形状语法也是一种创建视觉内容的有用语法[Stiny 80]。

当在根据需求测试内容并在未通过测试时丢弃内容的过程中使用时，这种方法在从设计者指定的规则（以语法的形式）自下而上出现和对内容的自上而下控制（以生成内容的接受规则的形式）之间取得了平衡。它仍然允许计算机探索设计空间，并得出令人惊讶和多样化的结果。

为基于语法的系统编写规则是通过将所需的内容分解成越来越小的部分来完成的。然后，语法将指定规则为非终结符和终结符。非终结符可以扩展为更多的非终结符和终结符，由一组规则指定。内容创建从一个非终结符开始，即开始符，然后根据一组扩展规则反复用新符号（可以是终结符、非终结符或两者的混合）替换非终结符，直到只剩下终结符。每个非终结符也可能有多个规则，从而允许创建不确定的内容。一些规则可能会比其他规则更频繁地被选择，这可以对将产生的内容类型提供一些额外的控制。

语法解释器负责选择下一个要展开的规则。将语法规则和解释器组合成一个大的分支控制流可能很诱人，对于简单的语法来说，这就足够了。然而，语法的力量往往在于能够快速添加或更改规则，并看到对内容的影响，语法经常会改变和增长以满足不断变化的设计约束。因此，最好将口译员和语法分开。

一个语法可以产生大量的内容——通常很快。不幸的是，语法容易过度生成，它们可能会创建语法规则设计时没有预期的内容。如果语法约束过于宽松，就无法保证它所能创造的一切都是好的内容。在语法规则中固定过度生成有时会过多地限制语法的能力，导致下一代——所有的内容现在都可能被认为是好的，但它也会感觉太相似和可预测了。因此，选择过度生成，然后对结果运行一系列测试，可以确保仍然生成令人惊讶的内容，但丢弃不可接受的内容。

为了实现这一点，必须定义一些易于衡量的验收标准（例如，一个级别必须至少有15个特征），用这些标准来剔除不良内容。这些标准还提供了一个机会，可以明确地定义在语法规则中难以指定甚至不可能指定的标准，并提供了一些自上而下的设计约束的能力，同时仍然受益于使用自下而上的规则进行生成所产生的新兴内容。

基于语法的方法的优势在于将简单、易于编写的规则与生成和测试参数相结合，这些规则提供了新兴和有趣的内容，使生成器能够满足软约束。语法规则也很容易用来表达设计模式。由于语法通常会很快生成内容，因此生成大量内容并将其丢弃并不昂贵。例如，Launchpad[Smith，G.11c]是一个未经优化的马里奥式平台关卡生成器。它基于语法的表示能够在几秒钟内创建一万个候选级别。这种方法的速度在很大程度上取决于语法规则的复杂性，但由于可以指定递归规则，速度也取决于允许的递归深度。语法的弱点在于它们难以满足硬设计约束和调试规则系统，这可能会变得相当复杂。

#### 40.2.1.4 优化

基于优化的生成器涉及一个搜索过程（通常是无界的），根据一些评估函数寻找组件的最佳组合。该评估函数通常被指定为试图计算设计能力的公式，搜索试图最大化该值。或者，可以有一个人在循环中，由人类玩家或设计师从候选者中选择他们最喜欢的内容。

进化算法是学术研究中基于优化的内容生成的一种流行方法。他们试图模仿自然进化。创建一个初始种群，然后繁殖和突变成一个新的种群，该种群可以通过适应度函数（或循环中的人类）进行评估。最好的候选人再次被培育和突变，他们的孩子也会被评估。这个循环一直持续到有一段内容非常适合评估函数，或者直到创建了最大数量的候选代，此时具有最佳评估的候选代
选择分数。

作为进化算法的一个简单示例，考虑按程序生成迷宫的问题。进化算法可能从一千个完全随机的迷宫开始。然后，它将根据特定候选迷宫满足评估标准的程度计算每个迷宫的适应度得分，并通过将评分较高的迷宫繁殖在一起——也许是通过将两个不同迷宫的左半部分和右半部分组合成一个新的迷宫——来生成新的迷宫种群。这个过程将被重复，直到经过了预定的时间，或者直到生成了符合验收标准的迷宫。

创建遗传算法有很多细微差别。基于优化的方法对所使用的知识表示也高度敏感（例如，将迷宫表示为一组具有端点和长度的墙壁，或表示为具有开放和封闭单元的网格）[McGuinness 12]，以及对算法的特定实现。

突变和育种操作员应该是什么？评估功能应该如何构建？应该如何选择繁殖与变异的种群百分比？是否应该为下一代保留一些候选人而不进行繁殖（称为精英主义）？有一篇关于基于搜索的 PCG 方法的调查文章为文献提供了一个很好的切入点[Togelius 11]。

所有基于优化的 PCG 方法都必须有一个评估函数——某种量化任意内容整体优劣的方法。这些评估函数可以是相当简单的近似值，例如从内容中成分的实际分布到这些成分的期望分布的距离。然而，在一个评估函数中很难捕捉到关于内容的所有重要信息。玩家体验建模[Yannakakis 11]是一种尝试，通过让玩家玩一些内容来学习单个玩家偏好的模型，然后将该模型作为适应度函数来创建个性化内容，从而更抽象地对待评估函数。玩家建模的一个更简单的用途是使用人类作为评估函数。银河军备竞赛是一款采用人在环方法的游戏，并使用玩家偏好的推断简单模型（玩家最常使用的武器是最理想的）来生成针对特定游戏风格个性化的新武器[Histans 09]。

基于优化的方法的使用依赖于对存在一个或多个最优内容的概念的舒适度，并且可以用数学方式表达出来。请注意，此评估函数不一定需要简化为乐趣的数学定义。相反，它可以是系统应该追求的一组理想的适当关系。如果发电机的设计有一个可以用数学表示的具体目标，那么这种方法可能是一种很好的方法。如果有一种方法让人在运行时指导生成过程，它也可以很好地工作。另一个好处是，与语法使用的生成和测试方法一样，基于优化的方法可用于软约束——内容的属性是理想的，但对游戏功能并不重要。然而，没有人类参与的进化算法可能很慢，玩家体验建模要求玩家接受训练级别，这对玩家来说可能很耗时，必须设计到游戏中。

#### 40.2.1.5 约束驱动

约束驱动方法是一种声明性方法，其中指定了硬设计约束，然后使用约束求解器来找到满足这些约束的所有潜在解决方案。所有内容都表示为具有潜在值范围的变量，约束决定了这些变量之间的关系。这种完全自上而下的方法允许将关于内容应该是什么样子的知识与底层搜索算法分开指定。

约束满足已被用于使用语义约束生成房间内部[Tutenel 09]，语义约束引入了关于对象是什么以及它们与其他对象的关系的知识（例如，桌子应该被椅子包围）。数值约束求解已被用于在平台架层中放置平台和其他层几何[Smith，G.11b]。答案集编程是一种在一阶逻辑中指定约束问题的方法，已被用于教育益智游戏[Smith，A.12]以及实时策略游戏 Warzone 2100[Smith, A. 11]的关卡中。

内容生成的约束满足挑战来自于充分指定所有约束。必须指定常识约束，例如两个对象不能同时占据同一位置的想法，以及更多特定于游戏的约束。然而，约束是表达设计空间的一种强大方法，当为了使内容可接受而必须满足许多约束时，这种方法效果很好。PCG约束满足方法的运行时性能因问题的大小、问题的描述方式和约束的数量而异。许多求解器，如答案集编程，通过将问题简化为布尔可满足性问题来工作，这是一个NP完全问题。然而，对于中小型领域，如迷宫、基于网格的益智游戏[Smith，A.11]，甚至简单的平台游戏[Smiths，G.11b]，基于约束的内容生成可以在几秒钟内产生结果，最坏的情况是几分钟。此外，添加约束实际上可以提高一些基于约束的系统的运行时性能，因为它允许系统快速消除搜索空间中不包含满意解决方案的部分。

### 40.2.2 知识表示

前一节中描述的许多方法可以通过改变知识表示来进一步变化，即内容生成器将拼凑在一起的构建块。这里，有四种主要的构建块，在创作控制和玩家识别常见模式的风险之间进行权衡。它们是按照人类创作从多到少的顺序排列的。

#### 40.2.2.1 体验块

体验块捕获了足够多的内容，在整个内容的上下文之外，玩家仍然可以将其作为自己的实体来体验。一个例子是机器人独角兽攻击中使用的关卡块。这种表示的一个优点是，对生成内容的外观有很大的艺术和设计控制，但玩家很有可能开始注意到相同的块一次又一次地重复。

Raph Koster 指出，游戏玩家是模式识别机器[Koster 04]，PCG 当然也是如此。除非需要模式识别，否则应避免或通过混合使用多种方法来设计生成器来缓和经验块（见第 40.2.3 节）。经验块通常与建构主义算法一起使用，但也可以与语法一起使用。

#### 40.2.2.2 模板

模板是一种更通用的体验块形式，设计团队仍然可以控制内容，但会留下空白供人工智能自动填写。模板就像PCG的疯狂 Libs，除非在构建模板和填补空白的内容规则方面小心谨慎，否则可能会产生与文字游戏相同的古怪后果。然而，模板可以在高保真游戏的作者控制和多样性之间取得很好的平衡。

模板是一种高级设计模式，设计模式文献可以为生成器的模板提供灵感。比约克和霍洛帕宁的书[Bjork 04]很好地收集了一般模式，但也有一些特定于类型的模式，如第一人称射击游戏[Hulett 10]、角色扮演游戏关卡和任务[Smith，G.11a，Onuczko 05]和 2D 平台游戏[Smith、G.11c]，仅举几个例子。

#### 40.2.2.3 组件

与模板一样，组件是由人类设计的模式。然而，与模板和体验块不同，组件不能单独作为内容来体验。例如，第一人称射击游戏中的敌人具有由人类设计师决定的一般行为，但如果没有他们所处级别的更广泛背景，就无法存在。使用组件可以降低玩家看到内容模式的风险。然而，这也意味着生成算法需要发挥更强大的作用，因为它几乎完全负责所生成内容的质量。组件模式可以很好地与本章中提到的所有生成方法配合使用。

#### 40.2.2.4 子组件

子组件表示使用尽可能小的资产。子组件没有关于内容是什么或应该如何使用的嵌入式语义信息。它们可以被想象成人类用来构建关卡的同一种积木，比如拼贴画中的艺术资产。很少有生成器使用这种方法来生成内容，因为生成器很难理解如何在没有大量内容语义信息的情况下将内容拼凑在一起，因此生成器更常见的是使用组件表示。例如，发电机了解房间或箱子的概念以及如何将它们放在一起是有帮助的。然而，银河军备竞赛[Hastings 09]是一款创建粒子系统武器的实验游戏，是使用这种表示的游戏的一个例子。

### 40.2.3 混合和匹配

这些方法和知识表示技术可以结合起来，生产出更复杂的系统，满足游戏设计的需求。例如，使用内容选择在运行时创建使用预先生成的内容片段（即体验块）的级别，可以减轻创作负担，增加PCG的多样性，同时仍然允许轻量级的生成算法；此外，使用预先生成的内容块可以在块之间提供比人类设计师容易创建的更多的多样性。Polymorph[Jennings Teats 10]是一个实验性的自适应关卡生成器，它使用这种方法创建根据玩家能力定制的关卡。每个预先生成的块都标有难度分数，随着玩家在关卡中的进步，具有适当难度分数的块（基于通过观察他们的失败对玩家技能水平的估计）被放置在玩家面前。

在不同的抽象层使用不同的内容生成技术可以帮助平衡人工创作和算法复杂性。例如，可以将基于模板的构造主义方法与约束求解器相结合，以创建地牢爬行器级别，从而将项目放置在未填充的插槽中的房间中。这将允许对房间的整体外观进行严格控制，并确保满足游戏要求，但仍然为房间的内容提供了高度的多样性。这个假设的生成器类似于Tanagra关卡设计助手[Smith，G.11b]中采用的生成方法，其中反应式规划与数值约束求解器结合使用，与人类设计师合作创建平台关卡。

混合和匹配范式可能非常强大，但它确实有一个主要缺点：一般来说，生成器的不同层将无法轻松地相互通信。在我们给出的地牢爬虫示例中，如果约束求解器无法将项目放入房间以满足所有设计约束，生成器必须返回并选择另一组房间模板，然后要求约束求解器重试。这是因为约束求解器无权更改房间布局，房间布局算法也不知道求解器关心的约束类型。在纯粹基于约束的系统中，房间布局可能会发生变化，以满足对标高组件的约束。

## 40.3 理解 PCG 与游戏的关系

现在我们已经了解了构建 PCG 系统的不同方法，让我们来看看如何理解 PCG 将在游戏中扮演的角色。这在很大程度上是一组设计决策，但它对人工智能系统的构建方式有很大的影响。

### 40.3.1 PCG 的机械作用

PCG 在游戏中的机械作用有几个重要方面，包括它如何融入整个游戏，玩家是否以及如何与之互动，以及设计师和玩家对它的控制程度。

### 40.3.1.1 游戏阶段

内容生成需要在玩家玩游戏时在线进行吗？或者，它可以在离线、关卡加载甚至游戏开发过程中发生吗？如果发电机必须经常在线运行，那么性能是最大的问题之一，可能有必要在一定程度上降低质量。另一方面，离线运行的生成器可能会更慢，但它需要能够创建足够灵活的内容，以支持玩家行为中固有的多样性（即内容不能
作为对玩家动作的响应而精心制作），并且它还必须高效地存储和加载生成的内容。

#### 40.3.1.2 与生成器的交互

在玩家确实与生成器交互的游戏中（而不仅仅是与生成的内容交互），玩家可能有三种主要的交互类型：参数化、偏好和直接操纵。

参数化控件允许玩家在生成器与内容交互之前设置一些影响生成器的参数。例如，《文明V》关卡生成器允许玩家设置世界年龄、温度和陆地类型等参数。

偏好控制意味着玩家可以（直接或间接）指定他们在游戏中接下来会看到什么内容的偏好。例如，银河之臂
种族根据玩家的行为推断出他们的偏好，使他们能够间接控制他们接下来会看到的武器类型。

直接操作允许玩家直接与内容交互，而生成器在后台运行以帮助玩家。这种控制出现在 Spore 的生物创建者中，玩家在其中构建生物模型，而内容生成器支持玩家的选择，并通过提供纹理和动画来增强它们。

#### 40.3.1.3 玩家体验控制

虽然可以构建一个内容生成器，简单地将预先编写的内容块拼接在一起（即建构主义方法），但通常希望有紧密的
对玩家体验的特定方面进行设计控制。这种控制可以有两种形式：组合和体验。

组合控制意味着生成器可以对最终产品中特定组件的存在做出设计保证，例如，一个平台游戏关卡生成器可以保证一个关卡中50%的挑战将是由于缺口造成的，或者一个任务生成器可以保证任务将涉及玩家找到两个愤怒的店主。

体验控制意味着生成器对玩家游戏体验的某些方面有了解，而不仅仅是组件放置，例如，一个平台生成器可以保证独立于存在的组件进行级别调整，或者一个任务生成器可以保证任务将具有与之相关的特定难度。

### 40.3.2 玩家与 PCG 的互动

PCG 的动态（借鉴自 Hunicke 等人用于分析游戏的力学、动力学和美学框架[Hunicke 04]）是玩家与生成内容互动产生的游戏风格。了解这些模式有助于选择要使用的技术和要创建的内容范围。

#### 40.3.2.1 PCG 与其他力学的关系

我们可以首先考虑 PCG 在游戏中相对于其他游戏机制的作用。玩家的体验是围绕生成的内容，还是我们创造的装饰性、附带的内容只会增强玩家的体验？一些游戏使用 PCG 来构建玩家体验：《文明 V》是一款游戏，在游戏的早期阶段，程序生成的地图为玩家提供了一些令人惊讶的探索，但玩家的大多数策略都围绕着游戏的其他方面（例如，构建顺序和军事策略）——事实上，存在许多具有固定、设计师生成地图的场景。另一方面，像 Canabalt 这样的无休止的跑步游戏有生成器，玩家的体验完全依赖于这些生成器。这些游戏除了与生成的内容交互外，没有其他机制。了解你的生成器将在多大程度上影响玩家的体验，可以帮助你决定如何集中精力，设计保证有多重要，以及如何确保玩家有足够的多样性。

#### 40.3.2.2 反应

PCG 通常用于创建令人惊讶或意外的内容，迫使玩家对不可预见的情况做出反应，而不是让他们重复记忆中的动作。这种反应可能与探索有关，如 Spelunky[Yu 09]，也可能是对反应时间的测试，如 Robot Unicorn Attack。反应来自 PCG 的随机元素，但您可能希望能够在一定程度上控制它。如果游戏会从玩家能够练习某些方面中受益，但仍然是对其他方面反应的测试，那么使用经验块可能是你知识表示的一个不错的选择。

#### 40.3.2.3 战略

使用在线运行且可由玩家直接或间接控制的内容生成器会导致玩家形成如何与生成器交互的策略。如果这种游戏风格是可取的，那么在设计生成器时应该考虑这些策略。例如，如果玩家应该能够围绕关卡中的挑战组合制定策略，如 Endless Web[Smith，G.12]，那么生成器的设计必须能够明确控制。

#### 40.3.2.4 搜索

玩家可以通过 PCG 进行两种搜索。首先，当生成的内容是一个世界时：玩家将搜索并探索它，寻找惊喜和有趣的时刻，就像在《我的世界》中一样。第二种是当内容较小并且可以在环境中找到时，玩家可以搜索有趣或独特的内容，就像在无主之地一样。无论搜索类型如何，从这种动态中吸取的教训都是一样的：生成器应该生成让玩家感到惊讶和兴奋的内容。一个生成器可能能够生成数百万个独特的内容，但如果这数百万个内容对玩家来说都是一样的，那么数量就没有意义了。引入惊喜和多样性可能很困难。它可能来自将小的、手工编写的内容片段合并到生成器中供玩家查找，也可能来自语法规则和权重的精心构建。

#### 40.3.2.5 练习

许多游戏使用 PCG 让玩家练习游戏策略。《文明 V》（以及其他带有生成地图的战略游戏）就是一个特别好的动态例子——游戏的其他机制提供了多种成功策略，土地和资源的程序性布局意味着玩家可以练习从这些策略中进行选择，并使其适应许多不同但可控的环境。在此类游戏中，尤其是多人游戏中，生成器对资源可用性、可玩性和平衡性做出设计保证的能力可能非常重要。基于约束的生成器，或使用生成和测试来满足设计要求的生成器，是需要这种保证的游戏的好技术。

#### 40.3.2.6 社区

最后，PCG 可以用来改变玩家的体验，这样就不可能为你的游戏编写漫游。这导致玩家之间有不同的体验。在制作 PCG 系统时，通常会考虑单个玩家对生成内容的体验，但对于某些游戏来说，考虑社区对该内容的体验也很重要。《矮人要塞》等游戏的粉丝们根据生成器提供的结果进行了漫长而持久的讨论和辩论，讲述了他们在自己独特世界中的经历。

## 40.4 选择方法

本节讨论了如何开始使用 PCG，如何选择方法，以及需要考虑的设计因素。

### 40.4.1 入门

有两种方法可以开始构建 PCG 系统：自下而上或自上而下。同时做这两件事可能会有所帮助，因为一种方法可能会激励你在另一种方法中做出决定。

自上而下的方法首先绘制出您希望能够创建的内容类型，并开发生成器应该具备的具体示例。从设计代表生成器可以生成的极端内容的示例开始可能特别有帮助：最简单和最难的级别是什么，最古怪的武器是什么，或者最丑陋和最漂亮的花是什么？如果有玩家应该控制的参数（例如，地图的大小或机器人的形状），这些是构建生成内容应该是什么样子的示例的有用起点。从这些例子中，开始提炼模式：这些将是生成器中的构建块。

自下而上的方法从工具中产生。例如，如果你认为语法方法是一个有趣的选择，那就开始写一些生产规则，看看你能从中得到什么样的内容。继续添加规则，调整你已经拥有的规则，直到你开始觉得你得到了你想要的东西。如果你对约束系统感兴趣，可以开始编写简单的可玩性约束，看看它们是如何出错的，然后迭代它们，添加更多或更改现有的约束，直到你得到你想看到的内容。

对于这两种方法，请记住，您使用的算法和拼凑在一起的构建块定义了一个大的概率空间，其中该空间中的每个点都是一个单独的内容。这个空间可能会有一些奇怪的曲折——如果不改变你的知识表示或算法，你可能永远无法制作出某些内容，而有些内容可能会过度制作，直到你控制了生成器。与其考虑如何创建一个完美的内容，不如考虑生成器中可能产生的潜在内容的空间。

### 40.4.2 游戏设计约束

PCG面临的困难之一是需要放弃一定程度的作者控制权。人类设计者控制玩家将看到的内容的能力受到允许动态生成内容的限制。考虑到这一点，在选择 PCG 技术时，您应该考虑（1）需要什么样的设计控制，以及（2）是否需要严格的设计保证，或者是否足以接近。例如，关卡生成器可能需要绝对保证关卡是可玩的，但这可能足以让关卡接近难度或节奏要求。就此而言，如果玩家被赋予改变环境的工具，或者如果可玩性问题很少发生，甚至可能不需要可玩性保证。这些约束可能会以不同的方式处理，具体取决于它们的重要性。例如，Launchpad 关卡生成器[Smith，G.11c]通过将其烘焙到生成算法中来保证关卡的可玩性，只允许合法放置关卡几何图形，但由于它使用了针对该设计约束的生成和测试，它不能保证完全满足不同关卡组件的期望频率。

当需要遵守设计的某些其他方面强加的规则时，会出现其他潜在的游戏设计约束。例如，如果有一个所有生成的关卡都必须融入的总体游戏叙事，那么必须有一种方法来表达叙事的重要方面，作为生成器的约束或规则。

### 40.4.3 与艺术的关系

假设 PCG 系统产生的部分或全部内容本质上是视觉的，那么 PCG 系统的设计必须与艺术家协调一致。除非包括纹理在内的所有内容都由计算机生成（这是一个艰巨的挑战），否则艺术家必须创建模块化资产供生成器使用。

艺术是选择不同类型构建块背后的主要动机之一：当艺术指导要求一个丰富而详细的世界，艺术家希望严格控制其外观时，体验块是好的。每个块的设计都需要使其能够与其他块兼容，但除此之外，它们可以独立存在。在另一个极端，子组件表示对于使用基于图块的表示（如 2D 侧滚动条）的游戏很有用，因此每个子组件都有一个可以与之关联的图块艺术资产。

对于生成器来说，加入一些艺术指导感可能仍然很重要，这样生成的内容的结构就适合被人类创造的艺术资产所覆盖。例如，在类似马里奥的游戏中，一个只有硬币和缺口的长而平坦的平台可能是可玩的，甚至提供了一个愉快的挑战，但可能不会在视觉上有趣。

### 40.4.4 工程约束

最后，在构建发电机时需要考虑重要的工程约束。算法速度和效率是一个很大的问题。虽然这里提出的方法都不能用于内容生成，但对于特定领域来说，有些方法肯定比其他方法更好。基于模拟和进化的方法往往相当缓慢，除非它们与玩家实时一起运行。基于约束的方法更难预测。根据变量的数量和所表达的约束的类型，约束系统实际上可以很快地解决一些内容生成问题。语法通常生成内容非常快，但可能需要稍微昂贵的生成和测试循环来剔除不需要的内容。

还有一个问题是，创建系统需要多长时间，更重要的是，测试和调试它需要多长时间。内容生成器是大量涌现的，因此即使遵循调试实践，如从已知的随机种子生成，也很难发现错误。基于约束的系统减少了对系统是否会意外创建不可播放内容的担忧，但可能更难编写和调试。尽管可以内置调试方法，但大多数当前的约束求解方法无法告诉您哪种约束组合导致了不满意的答案。另一方面，从相对简单的规则（如模拟和语法）构建内容的方法并不容易做出设计保证，但更容易编写。

## 40.5 调整和调试内容生成器

由于其突发性，调试PCG系统通常需要的不仅仅是抽查所生成的不同内容。调试使用大量随机性的系统的标准做法适用，例如，跟踪run-dom种子，以便更容易地再现错误，并记录生成过程中做出的决策（如果可能的话，考虑到使用的方法），以从系统中获得它正在做什么的解释。然而，对于复杂的PCG系统，仅凭这一点不足以了解系统正在做什么，以及对生成器所做的更改如何影响所生成的内容。

表达范围是指 PCG 系统可以产生的内容空间的形状，以及该空间可以控制的容易程度[Smith，G.10]。理解表达范围的一个好方法是定义所生成内容的重要、可测量的质量（指标），并生成这些指标的图形或其他可视化，以查看正在创建的内容类型。通过生成大量内容并使用这些指标评估每一部分，可以了解生成器的性能。第一步是只查看每个指标的最小值、最大值和中值——这将显示生成器能力极限的内容示例。例如，这是一种快速查看最简单和最难级别（对于某种难度近似值）以及平均难度级别的方法。这些指标可以是简单的近似值，例如根据难度将分数分配给不同级别的组件，并将它们平均在一起。更复杂的指标，包括自动游戏测试技术[Sarge 08]，也是可能的。

我们还可以使用表达范围分析，通过查看直方图中的数据，查看生成器是否似乎偏向于制作任何特定类型的内容。是否有一些箱子里的东西比其他箱子多？与其他类型的内容相比，生成器可能更倾向于创建该内容。热图可视化可以应用于2D直方图，以可视化生成器中的热点，并快速查看生成器不同版本的表现范围的变化。

通过预先投资创建这样的系统，可以看到生成器的小变化如何导致内容质量的变化，重新运行指标并看到新的表现力范围图。表达范围也可用于比较不同的发电机[喇叭14]。

## 40.6 结论

本章概述了内容生成技术，并讨论了它们的权衡，描述了 PCG 在游戏中可以扮演的许多角色，以及如何使用这些角色来指导哪种技术最好的决策，并给出了一些入门和调试 PCG 系统的建议。这只是对 PCG 领域的概述，还有更多的资源可用于学习特定技术或查找其他游戏如何实现自己的内容生成器。因此，本章将以资源列表结束，为您提供更多信息。

### 40.6.1 工具和框架

虽然大多数现成的工具不适合在大型游戏项目中使用，但这些工具和框架可以用作生成器的原型，用于实验和
看看有什么可能：

- 上下文无关艺术[Context Free Art 2014]及其表亲 StructureSynth[Christensen 10]是使用形状语法的可访问且记录良好的工具。它们旨在供数字艺术家使用，但也可用于模拟游戏内容生成器。
- Choco 是一个基于 Java 的免费开源数值约束求解器[Choco Team 2008]。
- Potasco 工具套件，特别是粘人胶，是开始答案集编程的好工具[Gebser 2011]。

### 40.6.2 阅读与社区

- 《游戏中的程序内容生成：教科书和当前研究概述》是一本由 PCG 社区著名研究人员撰写的书[Shaker 14]。
- PCG wiki是一个社区项目，旨在为文章和算法创建一个中央存储库[PGC wiki 14]。
- PCG 谷歌集团是一个活跃的开发者和学者社区，他们对 PCG 有着共同的兴趣[PGC group 14]。
- 对 PCG 进行了大量的学术研究。PCG 研究的常见场所是数字游戏基础（FDG）会议、程序内容生成（PCG）研讨会和交互式数字娱乐中的人工智能（AIIDE）会议。AIIDE 的论文可以通过 AAAI 的数字图书馆免费在线获取。许多 FDG 和 PCG 论文都存档在 ACM 数字图书馆中

# 41 《矮人要塞》的模拟原则

Tran Adams

## 41.1 介绍

《矮人要塞》是一款基于模拟的游戏，通过程序内容生成（PCG）为玩家生成独特的游戏世界[《矮人要塞14》]。在整个开发过程中，四个指导原则使游戏模拟保持了健壮性和易用性。本章将与您分享这些原则。

《矮人要塞》程序化地从头开始生成整个世界。该过程从基于随机分形生成的高程图开始。接下来，它创建了几个地图图层，包括温度、降雨、排水、植被和盐度。在定义了地图的原始组成部分后，下一步将每一块土地划分为不同的生物群落（植物和气候类型，如林地或热带稀树草原）。在模拟的下一阶段，临时河流会冲刷山脉，随后是从高地流向低地的永久河流。然后介绍植物和动物种群，然后是世界特定的幻想生物。至此，世界创造完成，文明模拟开始。通过这一过程，定居点得以建立，贸易路线得以形成，战争得以发动。在指定的时间点，模拟停止，玩家在一个独特的生活世界中开始游戏。

## 41.2 原则 1：不要过度规划你的模型

开发人员经常犯过度规划模型的错误。一般来说，这是一个力学问题，尤其是基于模拟的 PCG，因为你不能总是预测结果，也不一定想预测。玩自己的游戏并享受模拟中出现的东西会非常有益。作为一种总体策略，最好尽快让一些东西运行起来，然后从那里开始工作，直到你满意为止。与其过度规划模型，不如通过迭代来构建它。

## 41.3 原则 2：分解和理解系统

如果你只关注最终结果，就不清楚需要什么才能使其看起来和工作正常。相反，根据基本元素和交互来分解和理解你正在建模的系统。你不仅会发展出更丰富的物体相互作用，而且某些问题会自行解决。举个简单的例子，在创建地形时，它试图生成特定的生物群落或允许分形直接定义生物群落。然而，矮人要塞通过分别处理温度、降雨量、海拔、排水等字段，取得了更好的效果。这些场的相互作用决定了最终的生物群落，从而产生了一个更自然、内部一致的解决方案。

## 41.4 原则 3：不要过于复杂

如果 50 个变量不能对游戏产生有意义的影响，那么就没有理由对游戏行为的一个方面进行建模。在玩家看到的水平或下面一层进行操作。不要忘乎所以，制造出很多毫无价值的噪音。无用的复杂系统不仅会阻碍调优，还会在开发过程中产生瘫痪效应。只在需要的地方使用复杂性，否则力求简单。

## 41.5 原则 4：基于现实世界的类比建立模型

将你的模拟建立在现实的基础上是有帮助的。如果你有一个现实世界的模拟，你可以通过对基本原理的更广泛理解来纠正缺陷。例如，在《矮人要塞》中，当考虑到雨影时，世界地图得到了极大的改善（山脉阻挡了降雨天气系统，在另一边投下了干燥的阴影）。奇怪的是，排水是另一个不明显的考虑因素，有助于顺利地将森林与沼泽区分开来。我们知道现实世界是可行的，所以如果你回到现实中，只要有足够的内存和CPU时间，你通常也可以让模拟工作。

## 41.6 结论

无论你在模拟什么，前面的四个原则都应该帮助你制作出你真正想要的游戏。开始时，不要对模型进行过度规划。随着时间的推移建立模型，分解组件，并尝试充分理解底层系统。将模型建立在现实世界的类似物上，这样你就可以从已知有效的系统中受益。让各个元素结合起来，产生可以变化、令人惊讶但仍然对你的调整有反应的结果。通过保持简单，您可以避免黑盒模拟，并最终控制您的游戏。

有关更多信息和大量 PCG 提示和技巧，请参阅本书中的“程序内容生成：概述”章节或访问 PCG Wiki
[PGC Wiki 14]。
