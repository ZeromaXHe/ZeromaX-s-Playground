# 灵感

1. 自发光 Shader 可以参考[全息图着色器](https://www.bilibili.com/video/BV18e41197Yz)，用来做地球暗面的城市灯光？



# 速查

## 数学计算

正二十面体，假设每个边长为 1，则：

- 除去南北极的上下两个五边形：
  - 点距离五边形中心距离 = 2 / √(10-2√5) = 0.8506508083520399
  - 边离五边形中心的距离 = √(点距离五边形中心距离^2^ - 0.5^2^) = 0.6881909602355867
  - 五边形中心离极点距离 = √(1 - 点距离五边形中心距离^2^) = 0.5257311121191337
  - 两五边形之间距离 = 2 - 2 * 五边形中心离极点距离 = 0.9485377757617326
  - 面距离球心的距离 = 两五边形之间距离 / 2 = 0.4742688878808663
  - 点距离球心的距离（外接球半径） = √(面距离球心的距离^2^ + 点距离五边形中心距离^2^) = 0.9739290404139989
  - 点的纬度角 = arcsin(面距离球心的距离 / 点距离球心的距离) = 0.508610984 弧度 = 29.141262794 角度
  - 边距离球心的距离 = √(点距离球心的距离^2^ - 0.5^2^) = 0.835785723592915
  - 连接共边两点和球心的夹角 = 2 * arcsin(0.5 / 点距离球心的距离) = 2 * 0.53912398 弧度 = 2 * 30.88952869度 = 61.77905738 度 = 1.07824796 弧度

## C#

1. **格式字符串**：
   1. 标准数字格式字符串：https://learn.microsoft.com/zh-cn/dotnet/standard/base-types/standard-numeric-format-strings

# TODO

## 旧功能

### 我开发的

- [ ] 重复生成星球任务的互斥检测

### BUG FIX

- [ ] **网格生成**：目前地块连接和角落三角间存在接缝，估计是浮点数精度加上计算方向不同导致的
- [ ] **网格生成**：目前海面可能出现从中心到 3/4 边的接缝

### 重构

- [ ] GUI 和星球管理器之间的调用非常随意



## 新功能



- [ ] **GUI**：设置不可探索地块
- [ ] **GUI**：悬浮在地块上一定时间后显示的信息框



- [ ] **DGGS**：求最短路径上的所有地块（划线）



- [ ] **小地图**：拉伸分辨率时，改变小地图大小
- [ ] **小地图**：摄像头位置需要更精确，以及添加缓动过渡效果
- [ ] **小地图**：摄像头朝向指示（还有点难，因为摄像头在移动过程中自然会相对于球面旋转）
- [ ] **小地图**：小地图按照当前位置移动 X 轴到居中
- [ ] **小地图**：切换正二十面体展开方式（平铺还是中心六向）
- [ ] **小地图**：切换2D、3D大小地图功能



- [ ] **相机**：焦点处的 Box 换成一个飞船作为玩家观察聚焦点



- [ ] **美术效果**：更好看的天空盒（现在的太黑了）



# 正在开发



- [ ] **动态加载**：大量地块标签的优化，降低 Draw call
- [ ] **动态加载**：LOD 网格缓存引入数量限制，控制缓存内存占据的大小
- [ ] **动态加载**：合并低 LOD 的分块，降低 Draw call



- [ ] **地图生成**：实现 Sebastian 叠加噪声层原理生成地图的模式（这种才能使用计算着色器优化性能）
- [ ] **地图生成**：实现 Sebastian 根据现实地理数据生成真实地球地图的模式



- [ ] **GUI**：相机移动时显示南北极指示
- [ ] **GUI**：指南针（或者类似 Godot XYZ 的指示器）



- [ ] **小地图**：基本经纬度绘制



- [ ] **美术效果**：大气层
- [ ] **美术效果**：体积云



- [ ] 生成高和低于100半径星球时的最大高度、地表特征异常 bug fix
- [ ] 低半径时分块显示不出来 bug fix
- [ ] 事件的内存泄漏问题（相应对象一直在增加），新建星球时卡顿问题（从大星球开始，即使生成很小的星球也会卡）



# 已完成

## 2025-03-16

- [x] **美术效果**：水面法线贴图
- [x] **美术效果**：水面波浪效果
- [x] **Shader**：球面 vec3 到平面材质的 UV 的映射（使用三平面投射法 Triplanar 处理）

## 2025-03-15

- [x] **动态加载**：动态加载的分块会显示未探索的特征的 BUG FIX
- [x] **动态加载**：LOD 网格缓存
- [x] 确认高程视野的逻辑是否正确（定位为坐标距离 bug）
- [x] 确认地图生成的逻辑是否正确（定位为坐标距离 bug）
- [x] **地图生成**：BUG FIX，感觉算法有问题，经常在南北极点生成孤零零的地块，而且能明显看到正二十面体面的分界（定位为坐标距离 bug）
- [x] **动态加载**：快速移动时无分块加载 BUG FIX

## 2025-03-14

- [x] **动态加载**：特征考虑如何转为 MultiMesh，实现降低 Draw call

- [x] **动态加载**：优化地块加载过程，保证视野范围内没有缺口
- [x] **动态加载**：地形的 LOD？生成远距离观察或未来 2D、3D 地图切换为小地图后的低分辨率地形，省略阶梯等细节

## 2025-03-13

- [x] **网格生成**：高细分时扰动过大的问题 bug fix
- [x] **探索视野**：高细分时视野 Shader 高度 bug fix
- [x] **网格生成**：高细分时地面破皮问题 fix
- [x] **GUI**：通过 FPS 防止枪穿模的 Shader，显示低于高度的地块预览
- [x] **GUI**：地块预览渲染网格应该保证六个边都渲染

## 2025-03-12

- [x] **重构**：多例场景下的依赖注入优化
- [x] **重构**：将 HexMetrics 中的属性、方法提取成 Service
- [x] **重构**：将 GUI、星球管理器设置的参数下沉到 Service

## 2025-03-11

- [x] **小地图**：点击小地图跳转
- [x] **动态加载**：根据分块与相机间的位置关系，动态懒加载网格，而不是一次性全部生成。

## 2025-03-10

- [x] **GUI**：基本经纬度绘制
- [x] **GUI**：相机移动时显示经纬度指示，淡入淡出效果
- [x] **DGGS**：地块经纬度（地形生成需要用）
- [x] **GUI**：固定经纬度显隐按钮

- [x] **GUI**：编辑模式下已选择地块的可视化
- [x] **小地图**：摄像头位置指示

## 2025-03-09

- [x] **GUI**：编辑地形前的预览效果（透明、高优先级显示）
- [ ] ~~**GUI**：编辑地形预览效果地面下方的显示~~（试过，但是效果不好，最终放弃了）
- [x] **GUI**：编辑地形预览效果使用不同材质

## 2025-03-08

- [x] **单位寻路**：当前会有优先队列 -1 数组越界的 bug
- [x] **GUI**：编辑模式下显示地块 ID、坐标

## 2025-03-06

- [x] **特征视野**：instance uniform 数量太多报错，需要改成 MultiMesh 的实现？（实际上改成了控制 Visible）

- [x] **单位寻路**：单位移动中途，继续移动单位的 bug——录视频时发现：已经走过的地方会留下单位霸占位置，也可能是 AStar3D 更新逻辑错了（其实是单位漏设置地块 Id 了）
- [x] **单位寻路**：探索视野外的单位寻路（貌似没有被禁止）——需要按照原教程方式自己实现搜索？而不是 AStar3D？（确实放弃了 AStar3D，但原因其实是没有检查地块的探索属性）
- [x] 鼠标中键移动鼠标
- [x] **DGGS**：求任意两地块最短距离（可视范围要用）

## 2025-03-05

- [x] 更新 Godot 4.4（阿牟说的动画播放器 bug、生命周期）
- [x] 4.4 怎么设置 Jolt 物理？(设置器里可以改) 
- [x] 墙面的可见性（写个新 Shader）
- [x] 特征的可见性（Shader 的 instance uniform）
- [x] 简易小地图